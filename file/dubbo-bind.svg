<?xml version="1.0" encoding="utf-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd"><svg xmlns="http://www.w3.org/2000/svg" width="2478" height="1311" xmlns:xlink="http://www.w3.org/1999/xlink"><source><![CDATA[Title: Dubbo协议+Netty4传输，接口绑定过程
spring~SimpleApplicationEventMulticaster->ServiceBean: onApplicationEvent
ServiceBean->ServiceBean: doExportUrls
ServiceBean->ServiceBean: doExportUrlsFor1Protocol
ServiceBean-->RegistryProtocol: export
Note over ServiceBean,RegistryProtocol: 由dubbo扩展机制wrapper机制\nProtocolFilterWrapper和\nProtocolListenerWrapper装饰
RegistryProtocol->RegistryProtocol: doLocalExport
RegistryProtocol-->DubboProtocol: export
Note over RegistryProtocol,DubboProtocol: 由dubbo扩展机制wrapper机制\nProtocolFilterWrapper和\nProtocolListenerWrapper装饰\n并构造执行链
DubboProtocol->DubboProtocol: exporterMap.put(key, exporter)
DubboProtocol->DubboProtocol: openServer
Note over DubboProtocol: openServer方法中会先查看\n内存中是否存在相同的ip:port\n为key缓存的ExchangeServer
DubboProtocol->DubboProtocol: createServer
DubboProtocol->Exchangers: bind
Exchangers->HeaderExchanger: bind
note over Exchangers,HeaderExchanger: 这里会使用HeaderExchangerServer装饰\n具体的NettyServer，HeaderExchangerServer\n会异步定时处理心跳，调用的都是NettyServer\n提供的接口：server.getChannels()\n定时心跳任务默认不会开启，除非protocol中\n有配置heartbeat参数\nServer端对于心跳超时的处理是关闭连接\n连接过程HeaderExchangerClient也会装饰NettyClient\n Client端对于心跳超时的处理是重连
HeaderExchanger->Transporters: bind
Transporters-->NettyTransporter: bind
NettyTransporter->NettyServer: doOpen
NettyServer->netty~ServerBootstrap: bind

Note over Transporters,NettyTransporter: 动态编译源码，编译代码在\nExtensionLoader.getAdaptiveExtension\nExtensionLoader.createAdaptiveExtensionClassCode\n例如Transporter类传进去，会构造一个从url读取\n传输协议，如果读取不到，使用 Transporter 注解\nnetty来作为默认值的 Transporter 实现类]]></source><desc>Dubbo协议+Netty4传输，接口绑定过程</desc><defs><marker viewBox="0 0 5 5" markerWidth="5" markerHeight="5" orient="auto" refX="5" refY="2.5" id="markerArrowBlock"><path d="M 0 0 L 5 2.5 L 0 5 z"></path></marker><marker viewBox="0 0 9.6 16" markerWidth="4" markerHeight="16" orient="auto" refX="9.6" refY="8" id="markerArrowOpen"><path d="M 9.6,8 1.92,16 0,13.7 5.76,8 0,2.286 1.92,0 9.6,8 z"></path></marker></defs><g class="title"><rect x="10" y="10" width="282" height="26" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="15" y="29" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="15">Dubbo协议+Netty4传输，接口绑定过程</tspan></text></g><g class="actor"><rect x="10" y="46" width="340" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="20" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="20">spring~SimpleApplicationEventMulticaster</tspan></text></g><g class="actor"><rect x="10" y="1255.96875" width="340" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="20" y="1279.96875" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="20">spring~SimpleApplicationEventMulticaster</tspan></text></g><line x1="180" x2="180" y1="82" y2="1255.96875" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="370" y="46" width="108" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="380" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="380">ServiceBean</tspan></text></g><g class="actor"><rect x="370" y="1255.96875" width="108" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="380" y="1279.96875" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="380">ServiceBean</tspan></text></g><line x1="424" x2="424" y1="82" y2="1255.96875" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="582" y="46" width="148" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="592" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="592">RegistryProtocol</tspan></text></g><g class="actor"><rect x="582" y="1255.96875" width="148" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="592" y="1279.96875" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="592">RegistryProtocol</tspan></text></g><line x1="656" x2="656" y1="82" y2="1255.96875" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="800" y="46" width="124" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="810" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="810">DubboProtocol</tspan></text></g><g class="actor"><rect x="800" y="1255.96875" width="124" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="810" y="1279.96875" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="810">DubboProtocol</tspan></text></g><line x1="862" x2="862" y1="82" y2="1255.96875" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="1092" y="46" width="100" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1102" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1102">Exchangers</tspan></text></g><g class="actor"><rect x="1092" y="1255.96875" width="100" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1102" y="1279.96875" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1102">Exchangers</tspan></text></g><line x1="1142" x2="1142" y1="82" y2="1255.96875" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="1446" y="46" width="140" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1456" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1456">HeaderExchanger</tspan></text></g><g class="actor"><rect x="1446" y="1255.96875" width="140" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1456" y="1279.96875" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1456">HeaderExchanger</tspan></text></g><line x1="1516" x2="1516" y1="82" y2="1255.96875" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="1606" y="46" width="116" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1616" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1616">Transporters</tspan></text></g><g class="actor"><rect x="1606" y="1255.96875" width="116" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1616" y="1279.96875" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1616">Transporters</tspan></text></g><line x1="1664" x2="1664" y1="82" y2="1255.96875" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="1964" y="46" width="148" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1974" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1974">NettyTransporter</tspan></text></g><g class="actor"><rect x="1964" y="1255.96875" width="148" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1974" y="1279.96875" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1974">NettyTransporter</tspan></text></g><line x1="2038" x2="2038" y1="82" y2="1255.96875" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="2132" y="46" width="108" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="2142" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="2142">NettyServer</tspan></text></g><g class="actor"><rect x="2132" y="1255.96875" width="108" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="2142" y="1279.96875" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="2142">NettyServer</tspan></text></g><line x1="2186" x2="2186" y1="82" y2="1255.96875" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="2260" y="46" width="188" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="2270" y="70" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="2270">netty~ServerBootstrap</tspan></text></g><g class="actor"><rect x="2260" y="1255.96875" width="188" height="36" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="2270" y="1279.96875" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="2270">netty~ServerBootstrap</tspan></text></g><line x1="2354" x2="2354" y1="82" y2="1255.96875" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="signal"><text x="230" y="113" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="230">onApplicationEvent</tspan></text><line x1="180" x2="424" y1="118" y2="118" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="449" y="151" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="449">doExportUrls</tspan></text><line x1="424" x2="444" y1="138" y2="138" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="444" x2="444" y1="138" y2="159" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="444" x2="424" y1="159" y2="159" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="449" y="187" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="449">doExportUrlsFor1Protocol</tspan></text><line x1="424" x2="444" y1="174" y2="174" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="444" x2="444" y1="174" y2="195" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="444" x2="424" y1="195" y2="195" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="516" y="221" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="516">export</tspan></text><line x1="424" x2="656" y1="226" y2="226" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="414" y="246" width="252" height="64.390625" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="419" y="265" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="419">由dubbo扩展机制wrapper机制</tspan><tspan dy="1.2em" x="419">ProtocolFilterWrapper和</tspan><tspan dy="1.2em" x="419">ProtocolListenerWrapper装饰</tspan></text></g><g class="signal"><text x="681" y="343.390625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="681">doLocalExport</tspan></text><line x1="656" x2="676" y1="330.390625" y2="330.390625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="676" x2="676" y1="330.390625" y2="351.390625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="676" x2="656" y1="351.390625" y2="351.390625" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="735" y="377.390625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="735">export</tspan></text><line x1="656" x2="862" y1="382.390625" y2="382.390625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="646" y="402.390625" width="226" height="83.59375" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="651" y="421.390625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="651">由dubbo扩展机制wrapper机制</tspan><tspan dy="1.2em" x="651">ProtocolFilterWrapper和</tspan><tspan dy="1.2em" x="651">ProtocolListenerWrapper装饰</tspan><tspan dy="1.2em" x="651">并构造执行链</tspan></text></g><g class="signal"><text x="887" y="518.984375" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="887">exporterMap.put(key, exporter)</tspan></text><line x1="862" x2="882" y1="505.984375" y2="505.984375" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="882" x2="882" y1="505.984375" y2="526.984375" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="882" x2="862" y1="526.984375" y2="526.984375" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="887" y="554.984375" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="887">openServer</tspan></text><line x1="862" x2="882" y1="541.984375" y2="541.984375" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="882" x2="882" y1="541.984375" y2="562.984375" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="882" x2="862" y1="562.984375" y2="562.984375" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="749" y="577.984375" width="226" height="64.390625" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="754" y="596.984375" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="754">openServer方法中会先查看</tspan><tspan dy="1.2em" x="754">内存中是否存在相同的ip:port</tspan><tspan dy="1.2em" x="754">为key缓存的ExchangeServer</tspan></text></g><g class="signal"><text x="887" y="675.375" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="887">createServer</tspan></text><line x1="862" x2="882" y1="662.375" y2="662.375" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="882" x2="882" y1="662.375" y2="683.375" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="882" x2="862" y1="683.375" y2="683.375" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="986" y="709.375" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="986">bind</tspan></text><line x1="862" x2="1142" y1="714.375" y2="714.375" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="1313" y="745.375" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1313">bind</tspan></text><line x1="1142" x2="1516" y1="750.375" y2="750.375" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="1132" y="770.375" width="394" height="179.59375" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1137" y="789.375" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1137">这里会使用HeaderExchangerServer装饰</tspan><tspan dy="1.2em" x="1137">具体的NettyServer，HeaderExchangerServer</tspan><tspan dy="1.2em" x="1137">会异步定时处理心跳，调用的都是NettyServer</tspan><tspan dy="1.2em" x="1137">提供的接口：server.getChannels()</tspan><tspan dy="1.2em" x="1137">定时心跳任务默认不会开启，除非protocol中</tspan><tspan dy="1.2em" x="1137">有配置heartbeat参数</tspan><tspan dy="1.2em" x="1137">Server端对于心跳超时的处理是关闭连接</tspan><tspan dy="1.2em" x="1137">连接过程HeaderExchangerClient也会装饰NettyClient</tspan><tspan dy="1.2em" x="1137">Client端对于心跳超时的处理是重连</tspan></text></g><g class="signal"><text x="1574" y="980.96875" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1574">bind</tspan></text><line x1="1516" x2="1664" y1="985.96875" y2="985.96875" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="1835" y="1016.96875" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1835">bind</tspan></text><line x1="1664" x2="2038" y1="1021.96875" y2="1021.96875" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="2088" y="1052.96875" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="2088">doOpen</tspan></text><line x1="2038" x2="2186" y1="1057.96875" y2="1057.96875" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="2254" y="1088.96875" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="2254">bind</tspan></text><line x1="2186" x2="2354" y1="1093.96875" y2="1093.96875" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="note"><rect x="1654" y="1113.96875" width="394" height="122" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1659" y="1132.96875" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1659">动态编译源码，编译代码在</tspan><tspan dy="1.2em" x="1659">ExtensionLoader.getAdaptiveExtension</tspan><tspan dy="1.2em" x="1659">ExtensionLoader.createAdaptiveExtensionClassCode</tspan><tspan dy="1.2em" x="1659">例如Transporter类传进去，会构造一个从url读取</tspan><tspan dy="1.2em" x="1659">传输协议，如果读取不到，使用 Transporter 注解</tspan><tspan dy="1.2em" x="1659">netty来作为默认值的 Transporter 实现类</tspan></text></g></svg>